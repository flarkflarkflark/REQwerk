<!DOCTYPE html>
<html lang="en">
<head>
	<base href="../">
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>RECwerk - Multitrack Panel</title>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<style>
		html,body{height:100%}
		body{
			padding:0;
			margin:0;
			background:#091219;
			color:#d6e1e5;
			font-family:Helvetica, Arial, sans-serif;
			overflow:hidden;
			position:relative;
		}
		#chrome{
			display:flex;
			flex-direction:column;
			height:100%;
		}
		#header{
			padding:14px 16px 12px 16px;
			border-bottom:1px solid #21414f;
			background:linear-gradient(180deg, rgba(16,32,42,0.98), rgba(8,16,22,0.96));
		}
		#title{
			font-size:18px;
			font-weight:bold;
			letter-spacing:.04em;
			color:#fff;
		}
		#subtitle{
			margin-top:4px;
			font-size:12px;
			color:#8eaab2;
		}
		#content{
			flex:1 1 auto;
			min-height:0;
			overflow:auto;
			padding:14px 16px 16px 16px;
		}
		#d,#dl,#db,#e,#f{
			cursor:pointer;
			position:absolute;
			top:7px;
			right:7px;
			display:block;
			height:20px;
			z-index:99999;
			background:#eaeaea;
			left:auto;
			border-radius:4px;
			font-family:sans-serif;
			font-size:9px;
			width:82px;
			line-height:20px;
			padding:0 6px;
			text-align:center;
			opacity:.9;
			user-select:none;
			color:#111;
			text-decoration:none;
		}
		.b #e,.b #d,.b #dl,.b #db{top:12px}
		.b #e,.b #f{display:block}
		#dl{right:94px;width:76px}
		#db{right:176px;width:86px}
		#e{
			right:268px;
			width:10px;
			line-height:20px;
			padding:0 6px;
			display:none;
		}
		#f{
			left:0;
			right:0;
			top:0;
			padding:0;
			width:100%;
			line-height:0;
			border-radius:0;
			height:4px;
			background:#333;
			display:none;
		}
		.c #f,#f:hover{background:#3C3C3C}
		.pk_mtf_assets{
			max-height:none;
			overflow:visible;
			padding-right:0;
		}
		.pk_mtf_strips{
			margin-top:12px;
			padding-bottom:2px;
		}
	</style>
</head>
<body>
	<div id="chrome">
		<div id="header">
			<div id="title">Panel</div>
			<div id="subtitle"></div>
		</div>
		<div id="content">
			<div id="panel"></div>
		</div>
	</div>

	<a id="d" onclick="dockTo('right')">DOCK RIGHT</a>
	<a id="dl" onclick="dockTo('left')">DOCK LEFT</a>
	<a id="db" onclick="dockTo('bottom')">DOCK BOTTOM</a>
	<a id="e" onclick="remove()">X</a>
	<a id="f" onmousedown="drag(event)"></a>

	<script>
		(function () {
			var d = document;
			var w = window;
			var iframe = location.href.indexOf('?iframe') === -1 ? 0 : 1;
			var params = new URLSearchParams(location.search);
			var panelName = params.get('panel') || 'mixer';
			var targetId = 'pk_mt_' + panelName;

			function getHostWindow () {
				if (iframe) return w.parent;
				return w.opener;
			}

			function getEditor () {
				var host = getHostWindow ();
				return host && host.PKAudioEditor ? host.PKAudioEditor : null;
			}

			function getBridge () {
				var editor = getEditor ();
				return editor && editor.multitrackUI ? editor.multitrackUI : null;
			}

			w.remove = function () {
				if (iframe) {
					var editor = getEditor ();
					editor && editor.ui && editor.ui.Dock && editor.ui.Dock ('RequestShowMultitrackPanel', panelName, [1, 1]);
				} else {
					w.close && w.close ();
				}
			};

			if (iframe) {
				d.body.className = 'b';
			}

			w.drag = function ( e ) {
				e.preventDefault ();
				e.stopPropagation ();

				var editor = getEditor ();
				editor && editor.ui && editor.ui.Dock && editor.ui.Dock ('RequestDragMultitrackPanel', panelName);
			};

			w.dockTo = function ( dockTarget ) {
				var editor = getEditor ();
				if (!editor || !editor.fireEvent) return ;

				editor.fireEvent ('RequestDockMultitrackPanel', panelName, dockTarget || 'right');
				if (!iframe) {
					w.close && w.close ();
				}
			};

			function makePayload ( target ) {
				return {
					action: target.getAttribute('data-mt-action') || '',
					trackId: target.getAttribute('data-track-id') || '',
					clipId: target.getAttribute('data-clip-id') || '',
					assetId: target.getAttribute('data-asset-id') || '',
					flag: target.getAttribute('data-flag') || '',
					prop: target.getAttribute('data-mt-prop') || '',
					masterKey: target.getAttribute('data-mt-master') || '',
					tag: target.getAttribute('data-mt-tag') || '',
					value: target.value,
					keepSelection: false
				};
			}

			function render () {
				var bridge = getBridge ();
				if (!bridge || !bridge.renderFloatingPanel) return ;

				var payload = bridge.renderFloatingPanel ( panelName );
				d.getElementById('title').textContent = payload.title || 'Panel';
				d.getElementById('subtitle').textContent = payload.subtitle || '';
				d.getElementById('panel').innerHTML = payload.html || '';
				d.title = 'RECwerk - ' + (payload.title || 'Panel');
			}

			d.addEventListener ('click', function ( e ) {
				var target = e.target.closest('[data-mt-action]');
				if (!target) return ;

				var bridge = getBridge ();
				if (!bridge || !bridge.handleFloatingPanelAction) return ;

				var payload = makePayload ( target );
				payload.keepSelection = !!(e.shiftKey || e.ctrlKey || e.metaKey);
				bridge.handleFloatingPanelAction ( payload.action, payload );
			}, false);

			d.addEventListener ('input', function ( e ) {
				var target = e.target;
				if (!target) return ;

				var bridge = getBridge ();
				if (!bridge || !bridge.handleFloatingPanelInput) return ;

				var payload = makePayload ( target );
				if (payload.prop || payload.masterKey) {
					bridge.handleFloatingPanelInput ( payload );
				}
			}, false);

			d.addEventListener ('change', function ( e ) {
				var target = e.target;
				if (!target) return ;

				var bridge = getBridge ();
				if (!bridge || !bridge.handleFloatingPanelChange) return ;

				var payload = makePayload ( target );
				if (payload.tag) {
					bridge.handleFloatingPanelChange ( payload );
				}
			}, false);

			w.update = render;
			w.onunload = function () {
				w.destroy && w.destroy ( iframe );
				w.destroy = null;
			};

			setTimeout ( render, 60 );
		})();
	</script>
</body>
</html>
